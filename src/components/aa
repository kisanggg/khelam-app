import React, { useContext, useState } from "react";
import { TelephoneFill, Phone } from "react-bootstrap-icons";
import styles from "./clubdata.module.css";
import { Table, Modal, Form, Button } from "react-bootstrap";
import { DataContext } from "../../DataContext";
import moment from "moment";

const Clubbookingdata = ({ formData }) => {
  const {
    days,
    times,
    bookedTime,
    setBookedTime,
    disabledTimeSlots,
    setDisabledTimeSlots,
    displayModal,
    setDisplayModal,
    formDataList,
  } = useContext(DataContext);

  const [showModal, setShowModal] = useState(false);
  const [selectedFormData, setSelectedFormData] = useState(null);
  const [selectedDate, setSelectedDate] = useState(null);
  const [selectedTime, setSelectedTime] = useState(null);
  const [fullName, setFullName] = useState("");
  const [contactNumber, setContactNumber] = useState("");
  const [address, setAddress] = useState("");
  const [formErrors, setFormErrors] = useState({});

  const validateForm = () => {
    const errors = {};
    if (!fullName.trim()) {
      errors.fullName = "Full Name is required";
    }
    if (!contactNumber.trim()) {
      errors.contactNumber = "Contact Number is required";
    }else if (!/^[0-9]+$/.test(contactNumber.trim())) {
      errors.contactNumber = "Contact Number should contain only digits";
    }
    if (!address.trim()) {
      errors.address = "Address is required";
    }
    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleShowDetails = (formData) => {
    setDisplayModal(true);
    setSelectedFormData(formData);
  };

  const handleCloseModal = () => {
  setShowModal(false);
  setSelectedDate(null);
  setSelectedTime(null);
  setFullName("");
  setContactNumber("");
  setAddress("");
  setFormErrors({});
};

  const isSlotDisabled = (date, time) => {
    const dateString = moment(date).format("YYYY-MM-DD");
    const timeString = moment(time).format("hh A");
    return disabledTimeSlots.some(
      (slot) =>
        moment(slot.date).format("YYYY-MM-DD") === dateString &&
        moment(slot.time).format("hh A") === timeString
    );
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    const isValid = validateForm();
    if (isValid) {
      if (selectedDate && selectedTime) {
        const dateString = moment(selectedDate).format("YYYY-MM-DD");
        const timeString = moment(selectedTime).format("hh A");
        const bookingKey = `${dateString} ${timeString}`;
        setBookedTime((prevBookedTime) => ({
          ...prevBookedTime,
          [bookingKey]: true,
        }));
      }
    }
  };

  const handleDisableSlot = (date, time) => {
    const dateString = new Date(date);
    const timeString = moment(time, "hh A").toDate();
    const slotToDisable = { date: dateString, time: timeString };
    setDisabledTimeSlots((prevDisabledSlots) => [
      ...prevDisabledSlots,
      slotToDisable,
    ]);
    console.log("disable slot", disabledTimeSlots);
  };

  const renderSlotContent = (date, time, isBooked, isDisabled) => {
    const dateString = moment(date).format("YYYY-MM-DD");
    const timeString = moment(time).format("hh A");
    const slotFormData = formDataList.find(
      (formData) => formData.date === dateString && formData.time === timeString
    );

    if (isBooked && slotFormData) {
      return (
        <div className={styles.bookedSlot}>
          Booked
          <button
            className={styles.detailsBtn}
            onClick={() => handleShowDetails(slotFormData)}
          >
            Details
          </button>
        </div>
      );
    } else if (isDisabled) {
      return <div className={styles.disabledSlot}>Not Available</div>;
    } else if (isBooked) {
      return (
        <div>
          <p>Booked</p>
          <button className={styles.detailsButton}>Details</button>
        </div>
      );
    } else {
      return (
        <div className={styles.availableSlot}>
          Available
          <button
            onClick={() => {
              setSelectedDate(date);
              setSelectedTime(time);
              setShowModal(true);
            }}
            className={`${styles.bookBtn} ${styles.bookedBtn}`}
          >
            Book
          </button>
          <button
            onClick={() => handleDisableSlot(date, time)}
            className={styles.disableBtn}
          >
            Disable
          </button>
        </div>
      );
    }
  };

  const handleContactNumberChange = (e) => {
    const input = e.target.value;
    const numericInput = input.replace(/\D/g, "");
    setContactNumber(numericInput);
  };


  return (
    <div className={styles.clubdataWrapper}>
      <div className={styles.adminHeader}>
        <img
          src="https://marketplace.canva.com/EAFL8GIA214/1/0/1600w/canva-modern-minimalist-basketball-team-logo-gnFZBqra6FQ.jpg"
          alt="Club Logo"
          width={120}
          height={100}
        />
        <div className={styles.wrapper}>
          <h4>Club Name</h4>
          <p>Imadol, Lalitpur</p>
          <div className={styles.phoneWrapper}>
            <p>
              <TelephoneFill style={{ color: "red" }} /> 01-2453652
            </p>
            <p>
              <Phone style={{ color: "red" }} /> 9802542632
            </p>
          </div>
        </div>
      </div>
      <div className={styles.clubdataWrapper}>
        <Table striped bordered hover style={{ border: "1px solid black" }}>
          <thead>
            <tr>
              <th>Day/Date</th>
              {times.map((time, index) => (
                <th key={index}>{moment(time).format("hh A")}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {days.map(({ date, day }) => {
              const dateString = moment(date).format("YYYY-MM-DD");
              const daydatecombined = `${day} (${dateString})`;
              return (
                <tr key={dateString}>
                  <td className={styles.daydatecCell}>{daydatecombined}</td>
                  {times.map((time) => {
                    const timeString = moment(time).format("hh A");
                    const bookingKey = `${dateString} ${timeString}`;
                    const isBooked = bookedTime[bookingKey];
                    const isDisabled = isSlotDisabled(date, time);

                    return (
                      <td
                        key={`${dateString}-${timeString}`}
                        className={`${isBooked ? styles.bookedSlot : ""} ${
                          isDisabled ? styles.disabledSlot : ""
                        }`}
                      >
                        {renderSlotContent(date, time, isBooked, isDisabled)}
                      </td>
                    );
                  })}
                </tr>
              );
            })}
          </tbody>
        </Table>
      </div>

      <Modal show={showModal} onHide={handleCloseModal} className={styles.formModal}>
        <Modal.Header closeButton>
          <Modal.Title>Book Slot</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form onSubmit={handleSubmit}>
            <Form.Group controlId="fullName">
              <Form.Label>Full Name</Form.Label>
              <Form.Control
                type="text"
                value={fullName}
                className={styles.input}
                onChange={(e) => setFullName(e.target.value)}
                isInvalid={!!formErrors.fullName}
              />
              <Form.Control.Feedback type="invalid"  className={styles.errorWrapper}>{formErrors.fullName}</Form.Control.Feedback>
            </Form.Group>
            <Form.Group controlId="contactNumber">
              <Form.Label>Contact Number</Form.Label>
              <Form.Control
                type="tel"
                value={contactNumber}
                className={styles.input}
                onChange={ handleContactNumberChange}
                isInvalid={!!formErrors.contactNumber}
              />
              <Form.Control.Feedback type="invalid"  className={styles.errorWrapper}>{formErrors.contactNumber}</Form.Control.Feedback>
            </Form.Group>
            <Form.Group controlId="address">
              <Form.Label>Address</Form.Label>
              <Form.Control
                type="text"
                value={address}
                className={styles.input}
                onChange={(e) => setAddress(e.target.value)}
                isInvalid={!!formErrors.address}
              />
              <Form.Control.Feedback type="invalid" className={styles.errorWrapper}>{formErrors.address}</Form.Control.Feedback>
            </Form.Group>
            <Button type="submit" className={styles.confirmBtn}>
              Confirm
            </Button>
          </Form>
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default Clubbookingdata;
